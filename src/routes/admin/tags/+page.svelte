<script lang="ts">
	// Types
	import type { SuperValidated } from 'sveltekit-superforms';
	import type { PageData, ActionData } from './$types';

	// Libraries
	import toast from 'svelte-french-toast';
	import { superForm } from 'sveltekit-superforms/client';
	import SuperDebug from 'sveltekit-superforms/client/SuperDebug.svelte';

	// Page data
	export let data: PageData;
	let { tags } = data;
	const { tagEnums } = data;

	// Store
	import { tagsStore } from '$lib/stores/tagsStore';

	tagsStore.set(tags);

	// Components
	import { Check, ChevronsUpDown } from 'lucide-svelte';
	import { cn } from '$lib/utils';
	import { tick } from 'svelte';

	import * as Command from '$lib/components/ui/command';
	import * as Popover from '$lib/components/ui/popover';

	import { Textarea } from '$lib/components/ui/textarea';
	import { Input } from '$lib/components/ui/input';
	import { Button } from '$lib/components/ui/button';
	import { Label } from '$lib/components/ui/label';
	import DataTable from './data-table.svelte';
	import TagBadge from '$lib/components/TagBadge.svelte';

	const { form, errors, constraints, enhance, message } = superForm(data.form, {
		onUpdated({ form }) {
			if (form.valid) {
				// Successful post! Do some more client-side stuff,
				// like showing a toast notification.
				toast(form.message.text, { icon: '✅' });

				// console.log('page.svelte', form.message);

				// console.log(form);

				tagsStore.update((tags) => [
					{
						title: form.data.title,
						id: form.message.newId,
						slug: form.message.slug,
						type: form.message.type
					},
					...tags
				]);

				console.log($tagsStore);
			} else {
				toast.error(form.message, { icon: '❌' });
			}
		}
	});

	let open = false;
	let value = '';

	$: selectedValue = tagEnums.find((f) => f.value === value)?.label ?? 'Select a tag type...';

	// We want to refocus the trigger button when the user selects
	// an item from the list so users can continue navigating the
	// rest of the form with the keyboard.
	function closeAndFocusTrigger(triggerId: string) {
		open = false;
		tick().then(() => {
			document.getElementById(triggerId)?.focus();
		});
	}
</script>

<!-- <SuperDebug data={$form} /> -->

<!-- Useful for testing messages -->
<!--
    <div class="p-4 border-gray-300 border">
	{#if $message}
		<div class="message">{$message}</div>
	{:else}
		<div class="message"><p>No message!</p></div>
	{/if}
</div> -->
<div class="flex flex-col gap-8 max-w-screen-lg w-full">
	<div>
		<svg
			width="240"
			height="28"
			viewBox="0 0 240 28"
			fill="none"
			xmlns="http://www.w3.org/2000/svg"
		>
			<path
				d="M9 4V6H4V11H2V17H4V22H9V24H15V22H20V17H22V11H20V6H15V4H9ZM6 8H9V10H15V8H18V11H16V17H18V20H15V18H9V20H6V17H8V11H6V8Z"
				fill="#262626"
			/>
			<path
				d="M37.26 21V8.04H42.444C43.368 8.04 44.115 8.226 44.685 8.598C45.255 8.964 45.672 9.426 45.936 9.984C46.2 10.542 46.332 11.106 46.332 11.676C46.332 12.402 46.167 13.005 45.837 13.485C45.513 13.965 45.066 14.286 44.496 14.448V13.998C45.306 14.166 45.912 14.541 46.314 15.123C46.722 15.705 46.926 16.356 46.926 17.076C46.926 17.85 46.782 18.531 46.494 19.119C46.212 19.707 45.78 20.169 45.198 20.505C44.616 20.835 43.884 21 43.002 21H37.26ZM39.744 18.696H42.75C43.08 18.696 43.374 18.627 43.632 18.489C43.89 18.345 44.091 18.147 44.235 17.895C44.385 17.637 44.46 17.334 44.46 16.986C44.46 16.68 44.397 16.407 44.271 16.167C44.145 15.927 43.953 15.738 43.695 15.6C43.443 15.456 43.128 15.384 42.75 15.384H39.744V18.696ZM39.744 13.098H42.408C42.684 13.098 42.93 13.05 43.146 12.954C43.362 12.858 43.533 12.711 43.659 12.513C43.785 12.309 43.848 12.048 43.848 11.73C43.848 11.334 43.725 11.001 43.479 10.731C43.233 10.461 42.876 10.326 42.408 10.326H39.744V13.098ZM52.3389 21.288C51.5769 21.288 50.9559 21.159 50.4759 20.901C49.9959 20.643 49.6209 20.316 49.3509 19.92C49.0869 19.524 48.8979 19.113 48.7839 18.687C48.6699 18.255 48.6009 17.862 48.5769 17.508C48.5529 17.154 48.5409 16.896 48.5409 16.734V11.28H51.0249V15.87C51.0249 16.092 51.0369 16.377 51.0609 16.725C51.0849 17.067 51.1599 17.412 51.2859 17.76C51.4119 18.108 51.6159 18.399 51.8979 18.633C52.1859 18.867 52.5909 18.984 53.1129 18.984C53.3229 18.984 53.5479 18.951 53.7879 18.885C54.0279 18.819 54.2529 18.693 54.4629 18.507C54.6729 18.315 54.8439 18.036 54.9759 17.67C55.1139 17.298 55.1829 16.812 55.1829 16.212L56.5869 16.878C56.5869 17.646 56.4309 18.366 56.1189 19.038C55.8069 19.71 55.3359 20.253 54.7059 20.667C54.0819 21.081 53.2929 21.288 52.3389 21.288ZM55.4889 21V17.778H55.1829V11.28H57.6489V21H55.4889ZM60.3443 9.93V7.77H62.7923V9.93H60.3443ZM60.3443 21V11.28H62.7923V21H60.3443ZM65.6705 21V7.77H68.1185V21H65.6705ZM74.7586 21.27C73.8646 21.27 73.0816 21.045 72.4096 20.595C71.7376 20.145 71.2126 19.533 70.8346 18.759C70.4626 17.985 70.2766 17.112 70.2766 16.14C70.2766 15.15 70.4656 14.271 70.8436 13.503C71.2276 12.729 71.7646 12.12 72.4546 11.676C73.1446 11.232 73.9546 11.01 74.8846 11.01C75.8086 11.01 76.5856 11.235 77.2156 11.685C77.8456 12.135 78.3226 12.747 78.6466 13.521C78.9706 14.295 79.1326 15.168 79.1326 16.14C79.1326 17.112 78.9676 17.985 78.6376 18.759C78.3136 19.533 77.8276 20.145 77.1796 20.595C76.5316 21.045 75.7246 21.27 74.7586 21.27ZM75.1546 19.092C75.7006 19.092 76.1356 18.969 76.4596 18.723C76.7896 18.477 77.0266 18.132 77.1706 17.688C77.3146 17.244 77.3866 16.728 77.3866 16.14C77.3866 15.552 77.3146 15.036 77.1706 14.592C77.0266 14.148 76.7956 13.803 76.4776 13.557C76.1656 13.311 75.7546 13.188 75.2446 13.188C74.6986 13.188 74.2486 13.323 73.8946 13.593C73.5466 13.857 73.2886 14.214 73.1206 14.664C72.9526 15.108 72.8686 15.6 72.8686 16.14C72.8686 16.686 72.9496 17.184 73.1116 17.634C73.2736 18.078 73.5226 18.432 73.8586 18.696C74.1946 18.96 74.6266 19.092 75.1546 19.092ZM77.3866 21V14.34H77.0806V8.04H79.5466V21H77.3866ZM85.8502 9.93V7.77H88.2982V9.93H85.8502ZM85.8502 21V11.28H88.2982V21H85.8502ZM97.6203 21V16.41C97.6203 16.188 97.6083 15.906 97.5843 15.564C97.5603 15.216 97.4853 14.868 97.3593 14.52C97.2333 14.172 97.0263 13.881 96.7383 13.647C96.4563 13.413 96.0543 13.296 95.5323 13.296C95.3223 13.296 95.0973 13.329 94.8573 13.395C94.6173 13.461 94.3923 13.59 94.1823 13.782C93.9723 13.968 93.7983 14.244 93.6603 14.61C93.5283 14.976 93.4623 15.462 93.4623 16.068L92.0583 15.402C92.0583 14.634 92.2143 13.914 92.5263 13.242C92.8383 12.57 93.3063 12.027 93.9303 11.613C94.5603 11.199 95.3523 10.992 96.3063 10.992C97.0683 10.992 97.6893 11.121 98.1693 11.379C98.6493 11.637 99.0213 11.964 99.2853 12.36C99.5553 12.756 99.7473 13.17 99.8613 13.602C99.9753 14.028 100.044 14.418 100.068 14.772C100.092 15.126 100.104 15.384 100.104 15.546V21H97.6203ZM90.9783 21V11.28H93.1563V14.502H93.4623V21H90.9783ZM106.043 21V8.04H111.515C111.641 8.04 111.809 8.046 112.019 8.058C112.235 8.064 112.427 8.082 112.595 8.112C113.369 8.232 114.002 8.487 114.494 8.877C114.992 9.267 115.358 9.759 115.592 10.353C115.826 10.941 115.943 11.598 115.943 12.324C115.943 13.05 115.823 13.71 115.583 14.304C115.349 14.892 114.983 15.381 114.485 15.771C113.993 16.161 113.363 16.416 112.595 16.536C112.427 16.56 112.235 16.578 112.019 16.59C111.803 16.602 111.635 16.608 111.515 16.608H108.491V21H106.043ZM108.491 14.322H111.407C111.533 14.322 111.671 14.316 111.821 14.304C111.971 14.292 112.109 14.268 112.235 14.232C112.565 14.142 112.82 13.992 113 13.782C113.18 13.566 113.303 13.329 113.369 13.071C113.441 12.807 113.477 12.558 113.477 12.324C113.477 12.09 113.441 11.844 113.369 11.586C113.303 11.322 113.18 11.085 113 10.875C112.82 10.659 112.565 10.506 112.235 10.416C112.109 10.38 111.971 10.356 111.821 10.344C111.671 10.332 111.533 10.326 111.407 10.326H108.491V14.322ZM121.368 21.288C120.606 21.288 119.985 21.159 119.505 20.901C119.025 20.643 118.65 20.316 118.38 19.92C118.116 19.524 117.927 19.113 117.813 18.687C117.699 18.255 117.63 17.862 117.606 17.508C117.582 17.154 117.57 16.896 117.57 16.734V11.28H120.054V15.87C120.054 16.092 120.066 16.377 120.09 16.725C120.114 17.067 120.189 17.412 120.315 17.76C120.441 18.108 120.645 18.399 120.927 18.633C121.215 18.867 121.62 18.984 122.142 18.984C122.352 18.984 122.577 18.951 122.817 18.885C123.057 18.819 123.282 18.693 123.492 18.507C123.702 18.315 123.873 18.036 124.005 17.67C124.143 17.298 124.212 16.812 124.212 16.212L125.616 16.878C125.616 17.646 125.46 18.366 125.148 19.038C124.836 19.71 124.365 20.253 123.735 20.667C123.111 21.081 122.322 21.288 121.368 21.288ZM124.518 21V17.778H124.212V11.28H126.678V21H124.518ZM133.964 21.27C132.998 21.27 132.191 21.045 131.543 20.595C130.895 20.145 130.406 19.533 130.076 18.759C129.752 17.985 129.59 17.112 129.59 16.14C129.59 15.168 129.752 14.295 130.076 13.521C130.4 12.747 130.877 12.135 131.507 11.685C132.137 11.235 132.914 11.01 133.838 11.01C134.768 11.01 135.578 11.232 136.268 11.676C136.958 12.12 137.492 12.729 137.87 13.503C138.254 14.271 138.446 15.15 138.446 16.14C138.446 17.112 138.257 17.985 137.879 18.759C137.507 19.533 136.985 20.145 136.313 20.595C135.641 21.045 134.858 21.27 133.964 21.27ZM129.176 21V8.04H131.642V14.34H131.336V21H129.176ZM133.568 19.092C134.096 19.092 134.528 18.96 134.864 18.696C135.2 18.432 135.449 18.078 135.611 17.634C135.773 17.184 135.854 16.686 135.854 16.14C135.854 15.6 135.77 15.108 135.602 14.664C135.434 14.214 135.173 13.857 134.819 13.593C134.471 13.323 134.024 13.188 133.478 13.188C132.968 13.188 132.554 13.311 132.236 13.557C131.924 13.803 131.696 14.148 131.552 14.592C131.408 15.036 131.336 15.552 131.336 16.14C131.336 16.728 131.408 17.244 131.552 17.688C131.696 18.132 131.93 18.477 132.254 18.723C132.584 18.969 133.022 19.092 133.568 19.092ZM140.606 21V7.77H143.054V21H140.606ZM145.932 9.93V7.77H148.38V9.93H145.932ZM145.932 21V11.28H148.38V21H145.932ZM155.362 21.27C154.354 21.27 153.49 21.045 152.77 20.595C152.05 20.145 151.498 19.533 151.114 18.759C150.73 17.985 150.538 17.112 150.538 16.14C150.538 15.156 150.736 14.277 151.132 13.503C151.534 12.729 152.098 12.12 152.824 11.676C153.55 11.232 154.408 11.01 155.398 11.01C156.544 11.01 157.504 11.301 158.278 11.883C159.058 12.459 159.556 13.248 159.772 14.25L157.324 14.898C157.18 14.394 156.928 14.001 156.568 13.719C156.214 13.437 155.812 13.296 155.362 13.296C154.846 13.296 154.423 13.422 154.093 13.674C153.763 13.92 153.52 14.259 153.364 14.691C153.208 15.117 153.13 15.6 153.13 16.14C153.13 16.986 153.316 17.673 153.688 18.201C154.066 18.723 154.624 18.984 155.362 18.984C155.914 18.984 156.334 18.858 156.622 18.606C156.91 18.354 157.126 17.994 157.27 17.526L159.772 18.048C159.496 19.08 158.974 19.875 158.206 20.433C157.438 20.991 156.49 21.27 155.362 21.27ZM165.176 21V8.04H167.66L173.294 16.68V8.04H175.778V21H173.294L167.66 12.36V21H165.176ZM182.807 21.27C181.811 21.27 180.932 21.057 180.17 20.631C179.414 20.199 178.82 19.608 178.388 18.858C177.962 18.102 177.749 17.238 177.749 16.266C177.749 15.204 177.959 14.28 178.379 13.494C178.799 12.708 179.378 12.099 180.116 11.667C180.854 11.229 181.703 11.01 182.663 11.01C183.683 11.01 184.55 11.25 185.264 11.73C185.978 12.21 186.506 12.885 186.848 13.755C187.19 14.625 187.31 15.648 187.208 16.824H184.787V15.924C184.787 14.934 184.628 14.223 184.31 13.791C183.998 13.353 183.485 13.134 182.771 13.134C181.937 13.134 181.322 13.389 180.926 13.899C180.536 14.403 180.341 15.15 180.341 16.14C180.341 17.046 180.536 17.748 180.926 18.246C181.322 18.738 181.901 18.984 182.663 18.984C183.143 18.984 183.554 18.879 183.896 18.669C184.238 18.459 184.499 18.156 184.679 17.76L187.127 18.462C186.761 19.35 186.182 20.04 185.39 20.532C184.604 21.024 183.743 21.27 182.807 21.27ZM179.585 16.824V15.006H186.029V16.824H179.585ZM195.072 21C194.4 21.126 193.74 21.18 193.092 21.162C192.45 21.15 191.874 21.039 191.364 20.829C190.86 20.613 190.476 20.268 190.212 19.794C189.972 19.35 189.846 18.9 189.834 18.444C189.822 17.982 189.816 17.46 189.816 16.878V8.58H192.264V16.734C192.264 17.112 192.267 17.454 192.273 17.76C192.285 18.06 192.348 18.3 192.462 18.48C192.678 18.822 193.023 19.008 193.497 19.038C193.971 19.068 194.496 19.044 195.072 18.966V21ZM188.16 13.17V11.28H195.072V13.17H188.16ZM199.309 21L196.339 11.262L198.733 11.28L200.497 17.076L202.288 11.28H204.322L206.113 17.076L207.877 11.28H210.271L207.301 21H205.429L203.305 14.664L201.181 21H199.309ZM215.921 21.27C214.943 21.27 214.085 21.051 213.347 20.613C212.609 20.175 212.033 19.572 211.619 18.804C211.211 18.03 211.007 17.142 211.007 16.14C211.007 15.126 211.217 14.235 211.637 13.467C212.057 12.693 212.636 12.09 213.374 11.658C214.112 11.226 214.961 11.01 215.921 11.01C216.899 11.01 217.757 11.229 218.495 11.667C219.239 12.105 219.818 12.711 220.232 13.485C220.646 14.253 220.853 15.138 220.853 16.14C220.853 17.148 220.643 18.039 220.223 18.813C219.809 19.581 219.23 20.184 218.486 20.622C217.748 21.054 216.893 21.27 215.921 21.27ZM215.921 18.984C216.707 18.984 217.292 18.72 217.676 18.192C218.066 17.658 218.261 16.974 218.261 16.14C218.261 15.276 218.063 14.586 217.667 14.07C217.277 13.554 216.695 13.296 215.921 13.296C215.387 13.296 214.949 13.416 214.607 13.656C214.265 13.896 214.01 14.229 213.842 14.655C213.68 15.081 213.599 15.576 213.599 16.14C213.599 17.01 213.794 17.703 214.184 18.219C214.58 18.729 215.159 18.984 215.921 18.984ZM222.832 21V11.28H224.992V13.656L224.758 13.35C224.884 13.014 225.052 12.708 225.262 12.432C225.472 12.156 225.73 11.928 226.036 11.748C226.27 11.604 226.525 11.493 226.801 11.415C227.077 11.331 227.362 11.28 227.656 11.262C227.95 11.238 228.244 11.244 228.538 11.28V13.566C228.268 13.482 227.953 13.455 227.593 13.485C227.239 13.509 226.918 13.59 226.63 13.728C226.342 13.86 226.099 14.037 225.901 14.259C225.703 14.475 225.553 14.733 225.451 15.033C225.349 15.327 225.298 15.66 225.298 16.032V21H222.832ZM230.232 21L230.25 8.04H232.734V15.96L236.028 11.28H239.052L235.542 16.14L239.286 21H236.1L232.734 16.32V21H230.232Z"
				fill="#262626"
			/>
		</svg>
	</div>
	<h1 class="">Admin -> Tags</h1>
	<div class="flex gap-8 w-full basis-1/4 shrink-1 grow">
		<div
			class="flex justify-center w-full max-w-xs border bg-neutral-50 border-neutral-200 rounded-2xl p-8 h-fit shrink-0 shadow-2xl"
		>
			<form
				method="POST"
				action="?/create"
				use:enhance
				class="flex flex-col gap-8 w-full justify-center"
			>
				<div class="flex flex-col gap-2">
					<Label for="title">Title</Label>
					<Input
						class="bg-white"
						type="text"
						id="title"
						name="title"
						bind:value={$form.title}
						{...$constraints.title}
					/>
					<p class="text-sm text-muted-foreground">The title for the new tag.</p>
					{#if $errors.title}<span class="text-red-500">{$errors.title}</span>{/if}
				</div>
				<div class="flex flex-col gap-2">
					<Label for="description">Description</Label>
					<Textarea
						class="bg-white"
						id="description"
						name="description"
						bind:value={$form.description}
						{...$constraints.description}
					/>
					<p class="text-sm text-muted-foreground">The description of the new tag.</p>
					{#if $errors.description}<span class="text-red-500">{$errors.description}</span>{/if}
				</div>
				<div class="w-full">
					<div class="flex flex-col gap-2">
						<Label for="type">Types</Label>

						<Popover.Root bind:open let:ids>
							<Popover.Trigger asChild let:builder>
								<Button
									builders={[builder]}
									variant="outline"
									role="combobox"
									aria-expanded={open}
									class="w-full justify-between"
								>
									{selectedValue}
									<ChevronsUpDown class="ml-2 h-4 w-4 shrink-0 opacity-50" />
								</Button>
							</Popover.Trigger>
							<Popover.Content class="w-[200px] p-0">
								<Command.Root>
									<Command.Input placeholder="Search tag types..." />
									<Command.Empty>No tag type found.</Command.Empty>
									<Command.Group>
										{#each tagEnums as tagType}
											<Command.Item
												value={tagType.value}
												onSelect={(currentValue) => {
													value = currentValue;
													$form.type = value;
													closeAndFocusTrigger(ids.trigger);
												}}
											>
												<Check
													class={cn('mr-2 h-4 w-4', value !== tagType.value && 'text-transparent')}
												/>
												{tagType.label}
											</Command.Item>
										{/each}
									</Command.Group>
								</Command.Root>
							</Popover.Content>
						</Popover.Root>
					</div>
					<div class="flex flex-col gap-2">
						<Input
							class="hidden"
							aria-hidden
							type="text"
							id="type"
							name="type"
							bind:value={$form.type}
							{...$constraints.type}
						/>
						<div class="flex flex-col gap-4 mt-4 border rounded-xl p-4 b-neutral-200">
							<div class="flex justify-between items-center">
								<TagBadge type="business-model" />
								<p class="text-xs text-neutral-500">Business Model</p>
							</div>
							<div class="flex justify-between items-center">
								<TagBadge type="product-type" />
								<p class="text-xs text-neutral-500">Product Type</p>
							</div>
							<div class="flex justify-between items-center">
								<TagBadge type="other" />
								<p class="text-xs text-neutral-500">Other</p>
							</div>
						</div>
					</div>
				</div>
				<div>
					<Button type="submit" class="w-full">Submit</Button>
				</div>
			</form>
		</div>
		<div class="flex flex-col w-full basis-3/4 shrink-1 grow">
			<div class="w-full"><DataTable {tags} deleteForm={data.delteForm} /></div>
		</div>
	</div>
</div>
